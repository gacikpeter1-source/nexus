rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== Helper Functions ====================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of a document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Get user document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user is super admin
    function isSuperAdmin() {
      return isAuthenticated() && 
             getUserData().isSuperAdmin == true;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             (getUserData().role == 'admin' || isSuperAdmin());
    }
    
    // Check if user is club owner
    function isClubOwner(clubId) {
      return isAuthenticated() && 
             (get(/databases/$(database)/documents/clubs/$(clubId)).data.ownerId == request.auth.uid || isAdmin());
    }
    
    // Check if user is trainer in club
    function isTrainer(clubId) {
      let club = get(/databases/$(database)/documents/clubs/$(clubId)).data;
      return isAuthenticated() && 
             (request.auth.uid in club.trainers || 
              club.ownerId == request.auth.uid || 
              isAdmin());
    }
    
    // Check if user is member of club
    function isClubMember(clubId) {
      let club = get(/databases/$(database)/documents/clubs/$(clubId)).data;
      return isAuthenticated() && 
             (request.auth.uid in club.members || isAdmin());
    }
    
    // Check if user is parent
    function isParent() {
      return isAuthenticated() && 
             (getUserData().role == 'parent' || 
              getUserData().childIds != null);
    }
    
    // ==================== Users Collection ====================
    
    match /users/{userId} {
      // Anyone can read user profiles (needed for team lists, chat)
      allow read: if isAuthenticated();
      
      // Create: Own account OR parent creating child
      allow create: if isOwner(userId) || 
        (isAuthenticated() && 
         request.resource.data.managedByParentId == request.auth.uid);
      
      // Update: Own profile OR admin OR parent managing child OR club owner adding to club
      allow update: if isOwner(userId) || isAdmin() ||
        (isAuthenticated() && 
         resource.data.managedByParentId == request.auth.uid) ||
        // Allow club owners/trainers to update user's clubIds/teamIds when adding them
        (isAuthenticated() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['clubIds', 'teamIds', 'updatedAt']));
      
      // Delete: Own account OR admin (but can't delete super admin)
      allow delete: if (isOwner(userId) || isAdmin()) && 
                       resource.data.isSuperAdmin != true;
    }
    
    // ==================== Clubs Collection ====================
    
    match /clubs/{clubId} {
      // Read: Any authenticated user (needed for join request flow)
      // Users need to search and view clubs to request to join them
      allow read: if isAuthenticated();
      
      // Create: Any authenticated user with subscription
      allow create: if isAuthenticated() && 
                       request.resource.data.subscriptionActive == true &&
                       request.resource.data.ownerId == request.auth.uid;
      
      // Update: Club owners, trainers and admins
      allow update: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid ||
                        request.auth.uid in resource.data.trainers ||
                        isAdmin());
      
      // Delete: Club owner only (or admin)
      allow delete: if isAuthenticated() &&
                       (resource.data.ownerId == request.auth.uid || isAdmin());
    }
    
    // ==================== Teams ====================
    // NOTE: Teams are embedded within club documents, not a separate collection
    // Access is controlled via club permissions
    
    // ==================== Events Collection ====================
    
    match /events/{eventId} {
      // Read: Allow authenticated users to read events
      // Security: Users can only see events from their clubs (clubId in user's clubIds)
      // or their own personal events
      allow read: if isAuthenticated() && (
        // Personal events: creator only
        resource.data.createdBy == request.auth.uid ||
        // Team/Club events: if user is member of the club
        (resource.data.clubId != null && resource.data.clubId in getUserData().clubIds) ||
        // Admins can see everything
        isAdmin()
      );
      
      // Create: Personal events (any authenticated), Team/Club events (trainers only)
      allow create: if (request.resource.data.visibilityLevel == 'personal' && isAuthenticated()) ||
                       (request.resource.data.visibilityLevel in ['team', 'club'] && 
                        request.resource.data.clubId != null &&
                        isTrainer(request.resource.data.clubId)) ||
                       isAdmin();
      
      // Update: Event creator, trainers, club owners, OR users responding to events they can see
      allow update: if isOwner(resource.data.createdBy) || 
                       (resource.data.clubId != null && isTrainer(resource.data.clubId)) ||
                       (resource.data.clubId != null && isClubOwner(resource.data.clubId)) ||
                       isAdmin() ||
                       // Allow users to update their own RSVP (responses field only)
                       (isAuthenticated() && 
                        // User can read the event (is member of club or personal event owner)
                        (resource.data.createdBy == request.auth.uid ||
                         (resource.data.clubId != null && resource.data.clubId in getUserData().clubIds)) &&
                        // Only updating responses, confirmedCount, and updatedAt fields
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['responses', 'confirmedCount', 'updatedAt']));
      
      // Delete: Event creator, trainers, or club owners
      allow delete: if isOwner(resource.data.createdBy) || 
                       (resource.data.clubId != null && isTrainer(resource.data.clubId)) ||
                       (resource.data.clubId != null && isClubOwner(resource.data.clubId)) ||
                       isAdmin();
    }
    
    // ==================== Chats Collection ====================
    
    match /chats/{chatId} {
      // Read: Participants only
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participants;
      
      // Create: Participants
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      
      // Update: Participants (for unread counts, etc.)
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.participants;
      
      // Delete: Creator or admin
      allow delete: if isOwner(resource.data.createdBy) || isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        // Read: Chat participants
        allow read: if isAuthenticated() && 
                       request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Create: Chat participants
        allow create: if isAuthenticated() && 
                         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
                         request.resource.data.senderId == request.auth.uid;
        
        // Update: Message sender (for editing within 24h)
        allow update: if isOwner(resource.data.senderId);
        
        // Delete: Message sender or admin
        allow delete: if isOwner(resource.data.senderId) || isAdmin();
      }
    }
    
    // ==================== Subscriptions Collection ====================
    
    match /subscriptions/{subscriptionId} {
      // Read: Own subscription or club owner or admin
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid ||
                      isClubOwner(resource.data.clubId) ||
                      isAdmin());
      
      // Create/Update/Delete: Admin only
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== Vouchers Collection ====================
    
    match /vouchers/{voucherId} {
      // Read: Anyone (to check validity)
      allow read: if isAuthenticated();
      
      // Create/Delete: Admin only
      allow create, delete: if isAdmin();
      
      // Update: Admin can update everything, users can only redeem (increment usedCount)
      allow update: if isAdmin() ||
                       (isAuthenticated() && 
                        request.resource.data.status == resource.data.status &&
                        request.resource.data.usedCount == resource.data.usedCount + 1);
    }
    
    // ==================== Requests Collection (Join Requests) ====================
    
    match /requests/{requestId} {
      // Read: Request creator, club members (owner/trainers can see requests for their club), admins
      allow read: if isAuthenticated() && 
                     (request.auth.uid == resource.data.userId ||
                      request.auth.uid in get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.trainers ||
                      get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.ownerId == request.auth.uid ||
                      isAdmin());
      
      // Create: Any authenticated user
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Update: Club owner/trainers (to approve/reject) or admins
      allow update: if isAuthenticated() &&
                       (request.auth.uid in get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.trainers ||
                        get(/databases/$(database)/documents/clubs/$(resource.data.clubId)).data.ownerId == request.auth.uid ||
                        isAdmin());
      
      // Delete: Request creator or admin
      allow delete: if isAuthenticated() &&
                       (request.auth.uid == resource.data.userId || isAdmin());
    }
    
    // ==================== Parent-Child Relationships ====================
    
    match /parentChildRelationships/{relationId} {
      // Read: Parent or child in relationship
      allow read: if isAuthenticated() && 
                     (request.auth.uid == resource.data.parentId ||
                      request.auth.uid == resource.data.childId);
      
      // Create: Parent requesting link
      allow create: if isAuthenticated() && 
                       request.resource.data.parentId == request.auth.uid;
      
      // Update: Parent approving/rejecting
      allow update: if isAuthenticated() && 
                       request.auth.uid == resource.data.parentId;
      
      // Delete: Either parent or admin
      allow delete: if isAuthenticated() && 
                       (request.auth.uid == resource.data.parentId ||
                        request.auth.uid == resource.data.childId) ||
                       isAdmin();
    }
    
    // ==================== Attendance Collection ====================
    
    match /attendance/{attendanceId} {
      // Read: Club members
      allow read: if isClubMember(resource.data.clubId);
      
      // Create: Trainers and assistants
      allow create: if isTrainer(request.resource.data.clubId);
      
      // Update: Trainer who created it
      allow update: if isOwner(resource.data.takenBy) || 
                       isClubOwner(resource.data.clubId) ||
                       isAdmin();
      
      // Delete: Club owners and admins
      allow delete: if isClubOwner(resource.data.clubId) || isAdmin();
    }
    
    // ==================== Seasons Collection ====================
    
    match /seasons/{seasonId} {
      // Read: Club members
      allow read: if isClubMember(resource.data.clubId);
      
      // Create/Update: Club owners
      allow create, update: if isClubOwner(request.resource.data.clubId) || isAdmin();
      
      // Delete: Club owners
      allow delete: if isClubOwner(resource.data.clubId) || isAdmin();
    }
    
    // ==================== League Schedule ====================
    
    match /leagueSchedule/{gameId} {
      // Read: Club members
      allow read: if isClubMember(resource.data.clubId);
      
      // Create/Update: Trainers (from scraper)
      allow create, update: if isTrainer(request.resource.data.clubId) || isAdmin();
      
      // Delete: Club owners
      allow delete: if isClubOwner(resource.data.clubId) || isAdmin();
    }
    
    // ==================== Training Library ====================
    
    match /trainingLibrary/{trainingId} {
      // Read: Club members or public
      allow read: if resource.data.isPublic == true || 
                     isClubMember(resource.data.clubId) ||
                     isAdmin();
      
      // Create: Trainers
      allow create: if isTrainer(request.resource.data.clubId);
      
      // Update/Delete: Creator or club owners
      allow update, delete: if isOwner(resource.data.createdBy) ||
                               isClubOwner(resource.data.clubId) ||
                               isAdmin();
    }
    
    // ==================== Notifications ====================
    
    match /notifications/{notificationId} {
      // Read/Update: Own notifications
      allow read, update: if isOwner(resource.data.userId);
      
      // Create: Own notifications
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Delete: Own notifications or admin
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // ==================== Pending Notifications ====================
    
    match /pendingNotifications/{notificationId} {
      // Read: Recipient or admin
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Create/Update/Delete: Cloud Functions only (admin)
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== Feedback ====================
    
    match /feedback/{feedbackId} {
      // Read: Creator or admin
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Create: Any authenticated user
      allow create: if isAuthenticated();
      
      // Update: Admin only (to respond)
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ==================== Audit Logs ====================
    
    match /auditLogs/{logId} {
      // Read: Admin only
      allow read: if isAdmin();
      
      // Create: Any authenticated user (for logging their actions)
      allow create: if isAuthenticated();
      
      // Update/Delete: Never (logs are immutable)
      allow update, delete: if false;
    }
  }
}


